<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xsukax KML/KMZ Map Viewer</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body { padding: 0; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        #map { height: calc(100vh - 200px); width: 100%; border-radius: 0; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); color: white; padding: 2rem 0; box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: pulse 15s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.3; } }
        .brand-logo { font-size: 2rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); position: relative; z-index: 1; }
        .brand-accent { color: #fbbf24; font-weight: 800; }
        .subtitle { font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem; position: relative; z-index: 1; }
        .upload-section { background: white; padding: 2rem; border-bottom: 3px solid #e5e7eb; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card-upload { background: #ffffff; border-radius: 12px; padding: 1.5rem; border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .card-upload:hover { border-color: #7e22ce; box-shadow: 0 4px 12px rgba(126,34,206,0.1); }
        .file-input-wrapper { position: relative; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { display: none; }
        .file-input-label { display: inline-flex; align-items: center; justify-content: center; padding: 0.875rem 2rem; background: linear-gradient(135deg, #7e22ce 0%, #5b21b6 100%); color: white; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(126,34,206,0.3); }
        .file-input-label:hover { background: linear-gradient(135deg, #6b21a8 0%, #4c1d95 100%); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(126,34,206,0.4); }
        .file-input-label i { margin-right: 0.5rem; }
        .status-message { margin-top: 1rem; padding: 1rem 1.25rem; border-radius: 8px; display: none; font-weight: 500; border-left: 4px solid; }
        .status-message.show { display: flex; align-items: center; }
        .status-message i { margin-right: 0.75rem; font-size: 1.2rem; }
        .status-success { background: #d1fae5; color: #065f46; border-left-color: #10b981; }
        .status-error { background: #fee2e2; color: #991b1b; border-left-color: #ef4444; }
        .status-info { background: #dbeafe; color: #1e40af; border-left-color: #3b82f6; }
        .layer-info { padding: 1rem 1.25rem; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 8px; margin-top: 1rem; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #7e22ce; }
        .layer-info.show { display: flex; align-items: center; }
        .layer-info i { margin-right: 0.75rem; color: #7e22ce; font-size: 1.2rem; }
        .clear-btn { margin-left: 1rem; background: #ef4444; color: white; border: none; padding: 0.875rem 1.5rem; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(239,68,68,0.3); }
        .clear-btn:hover { background: #dc2626; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239,68,68,0.4); }
        .clear-btn i { margin-right: 0.5rem; }
        .feature-label { background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); border: 2px solid #7e22ce; padding: 6px 14px; border-radius: 6px; font-weight: 600; font-size: 13px; color: #1f2937; box-shadow: 0 4px 12px rgba(0,0,0,0.2); white-space: nowrap; pointer-events: none; }
        .leaflet-tooltip.feature-label::before { display: none; }
        .info-badge { display: inline-block; padding: 0.35rem 0.75rem; background: #7e22ce; color: white; border-radius: 6px; font-size: 0.85rem; font-weight: 600; margin-left: 0.5rem; }
        .map-container { padding: 1.5rem; background: white; margin: 0; }
        .footer-note { text-align: center; padding: 1rem; color: #6b7280; font-size: 0.85rem; background: #f9fafb; }
        .footer-note a { color: #7e22ce; text-decoration: none; font-weight: 600; }
        .footer-note a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header animate__animated animate__fadeInDown">
        <div class="container">
            <div class="brand-logo">
                <i class="fas fa-map-marked-alt"></i>
                <span class="brand-accent">xsukax</span> KML/KMZ Map Viewer
            </div>
            <div class="subtitle">
                <i class="fas fa-layer-group"></i> Professional Geospatial Mapping Solution
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section animate__animated animate__fadeIn">
        <div class="container">
            <div class="card-upload">
                <div class="row align-items-center">
                    <div class="col-lg-7 col-md-12 mb-3 mb-lg-0">
                        <div class="file-input-wrapper">
                            <input type="file" id="fileInput" accept=".kml,.kmz" />
                            <label for="fileInput" class="file-input-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                Select KML/KMZ File
                            </label>
                            <button id="clearBtn" class="clear-btn" style="display: none;">
                                <i class="fas fa-trash-alt"></i>
                                Clear Map
                            </button>
                        </div>
                        <div id="statusMessage" class="status-message"></div>
                        <div id="layerInfo" class="layer-info"></div>
                    </div>
                    <div class="col-lg-5 col-md-12 text-lg-end">
                        <div>
                            <span class="info-badge">
                                <i class="fas fa-file-code"></i> KML
                            </span>
                            <span class="info-badge">
                                <i class="fas fa-file-archive"></i> KMZ
                            </span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Drag & drop or click to upload
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
        <div class="container-fluid">
            <div id="map"></div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer-note">
        Powered by <a href="#" target="_blank">xsukax</a> | Built with Leaflet & OpenStreetMap
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <!-- JSZip for KMZ handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- ToGeoJSON for KML parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

    <script>
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let currentLayerGroup = null;
        const fileInput = document.getElementById('fileInput');
        const statusMessage = document.getElementById('statusMessage');
        const layerInfo = document.getElementById('layerInfo');
        const clearBtn = document.getElementById('clearBtn');

        function showStatus(message, type) {
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
            statusMessage.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
            statusMessage.className = `status-message show status-${type} animate__animated animate__fadeIn`;
            setTimeout(() => {
                if (type === 'success' || type === 'info') {
                    statusMessage.classList.remove('show');
                }
            }, 5000);
        }

        function showLayerInfo(featureCount) {
            layerInfo.innerHTML = `
                <i class="fas fa-layer-group"></i>
                <span><strong>Layer loaded:</strong> ${featureCount} feature${featureCount !== 1 ? 's' : ''} displayed on map</span>
            `;
            layerInfo.classList.add('show', 'animate__animated', 'animate__fadeIn');
        }

        function clearMap() {
            if (currentLayerGroup) {
                map.removeLayer(currentLayerGroup);
                currentLayerGroup = null;
            }
            layerInfo.classList.remove('show');
            statusMessage.classList.remove('show');
            clearBtn.style.display = 'none';
            fileInput.value = '';
        }

        function getFeatureStyle(feature) {
            return { color: '#7e22ce', weight: 3, opacity: 0.8, fillOpacity: 0.3, fillColor: '#a855f7' };
        }

        function createPopupContent(properties) {
            if (!properties || Object.keys(properties).length === 0) {
                return '<div style="padding: 0.5rem;"><i class="fas fa-info-circle"></i> No additional information</div>';
            }
            
            let content = '<div style="max-width: 300px; font-size: 0.9rem;">';
            for (const [key, value] of Object.entries(properties)) {
                if (value && key !== 'styleUrl' && key !== 'styleHash') {
                    content += `<div style="margin-bottom: 0.5rem;"><strong style="color: #7e22ce;">${key}:</strong> ${value}</div>`;
                }
            }
            content += '</div>';
            return content;
        }

        function displayGeoJSON(geojson) {
            if (!geojson || !geojson.features || geojson.features.length === 0) {
                showStatus('No valid features found in the file', 'error');
                return;
            }

            if (currentLayerGroup) {
                map.removeLayer(currentLayerGroup);
            }

            currentLayerGroup = L.geoJSON(geojson, {
                style: getFeatureStyle,
                pointToLayer: (feature, latlng) => {
                    return L.circleMarker(latlng, {
                        radius: 10,
                        fillColor: '#7e22ce',
                        color: '#fff',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.9
                    });
                },
                onEachFeature: (feature, layer) => {
                    const props = feature.properties || {};
                    const popupContent = createPopupContent(props);
                    layer.bindPopup(popupContent, { maxWidth: 350, className: 'custom-popup' });
                    
                    const name = props.name || props.Name;
                    if (name) {
                        layer.bindTooltip(name, {
                            permanent: true,
                            direction: 'top',
                            className: 'feature-label',
                            offset: [0, -15]
                        });
                    }
                }
            }).addTo(map);

            try {
                const bounds = currentLayerGroup.getBounds();
                map.fitBounds(bounds, { padding: [50, 50] });
            } catch (e) {
                console.log('Bounds fitting skipped');
            }

            showStatus('File loaded successfully!', 'success');
            showLayerInfo(geojson.features.length);
            clearBtn.style.display = 'inline-block';
        }

        function parseKML(kmlText) {
            try {
                const parser = new DOMParser();
                const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
                
                const parserError = kmlDoc.querySelector('parsererror');
                if (parserError) {
                    throw new Error('Invalid KML format');
                }

                const geojson = toGeoJSON.kml(kmlDoc);
                displayGeoJSON(geojson);
            } catch (error) {
                showStatus('Error parsing KML file: ' + error.message, 'error');
            }
        }

        async function handleKMZ(file) {
            try {
                showStatus('Processing KMZ file...', 'info');
                
                const zip = new JSZip();
                const contents = await zip.loadAsync(file);
                
                let kmlFile = null;
                for (const [filename, fileData] of Object.entries(contents.files)) {
                    if (filename.toLowerCase().endsWith('.kml') && !fileData.dir) {
                        kmlFile = fileData;
                        break;
                    }
                }

                if (!kmlFile) {
                    throw new Error('No KML file found in KMZ archive');
                }

                const kmlText = await kmlFile.async('text');
                parseKML(kmlText);
            } catch (error) {
                showStatus('Error processing KMZ file: ' + error.message, 'error');
            }
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            
            if (!fileName.endsWith('.kml') && !fileName.endsWith('.kmz')) {
                showStatus('Please select a valid KML or KMZ file', 'error');
                fileInput.value = '';
                return;
            }

            if (fileName.endsWith('.kmz')) {
                await handleKMZ(file);
            } else {
                showStatus('Loading KML file...', 'info');
                const reader = new FileReader();
                reader.onload = (event) => {
                    parseKML(event.target.result);
                };
                reader.onerror = () => {
                    showStatus('Error reading file', 'error');
                };
                reader.readAsText(file);
            }
        });

        clearBtn.addEventListener('click', clearMap);
        
        console.log('xsukax KML/KMZ Map Viewer initialized successfully');
    </script>
</body>
</html>